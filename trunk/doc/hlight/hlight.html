<html>
<head>
<link rel="stylesheet" type="text/css" href="code.css"/>
</head>
<body><pre>
<span class="dsKeyword">require</span> <span class="dsString">'rexml/document'</span>
<span class="dsKeyword">require</span> <span class="dsString">'set'</span>
<span class="dsKeyword">require</span> <span class="dsString">'strscan'</span>
<span class="dsKeyword">require</span> <span class="dsString">'cgi'</span>

<span class="dsKeyword">class</span> Keyword
  <span class="dsOthers">attr_reader</span><span class="dsString"> :name</span>,<span class="dsString"> :type</span>
<span class="dsKeyword">  def </span>initialize(name, type)
    <span class="dsOthers">@name</span> = name
    <span class="dsOthers">@type</span> = type
<span class="dsKeyword">  end</span>
<span class="dsKeyword">end</span>

<span class="dsKeyword">class</span> HighlightRules
<span class="dsKeyword">  class </span>Context
    <span class="dsOthers">attr_reader</span><span class="dsString"> :name</span>,<span class="dsString"> :attribute</span>,<span class="dsString"> :line_end_context</span>
<span class="dsKeyword">    def </span>initialize(context_element)
      <span class="dsOthers">@name</span> = context_element<span class="dsFloat">.</span>attribute(<span class="dsString">&quot;name&quot;</span>)<span class="dsFloat">.</span>value
      <span class="dsOthers">@attribute</span> = context_element<span class="dsFloat">.</span>attribute(<span class="dsString">&quot;attribute&quot;</span>)<span class="dsFloat">.</span>value
      <span class="dsOthers">@line_end_context</span> = context_element<span class="dsFloat">.</span>attribute(<span class="dsString">&quot;lineEndContext&quot;</span>)<span class="dsFloat">.</span>value
      <span class="dsOthers">@rules</span> = Set<span class="dsFloat">.</span>new
<span class="dsKeyword">    end</span>
    
<span class="dsKeyword">    def </span>add_rule(rule)
      <span class="dsOthers">@rules</span><span class="dsFloat">.</span>add(rule)
<span class="dsKeyword">    end</span>
    
<span class="dsKeyword">    def </span>each_rule(&amp;blk)
      <span class="dsOthers">@rules</span><span class="dsFloat">.</span>each(&amp;blk)
<span class="dsKeyword">    end</span>
    
    <span class="dsKeyword">alias</span> each each_rule
<span class="dsKeyword">  end</span>

  <span class="dsOthers">attr_reader</span><span class="dsString"> :contexts</span>,<span class="dsString"> :itemdata</span>
<span class="dsKeyword">  def </span>initialize(file)
    <span class="dsOthers">@rules</span> = REXML::Document<span class="dsFloat">.</span>new(file)<span class="dsFloat">.</span>elements<span class="dsChar">[</span><span class="dsString">&quot;language&quot;</span><span class="dsChar">]</span><span class="dsFloat">.</span>elements<span class="dsChar">[</span><span class="dsString">&quot;highlighting&quot;</span><span class="dsChar">]</span>
    
   <span class="dsComment"> # read keywords</span>
    <span class="dsOthers">@keywords</span> = <span class="dsChar">{}</span>
    <span class="dsOthers">@rules</span><span class="dsFloat">.</span>each_element(<span class="dsString">&quot;list&quot;</span>)<span class="dsKeyword"> do </span>|list|
      type = list<span class="dsFloat">.</span>attribute(<span class="dsString">&quot;name&quot;</span>)<span class="dsFloat">.</span>value
      <span class="dsOthers">@keywords</span><span class="dsChar">[</span>type<span class="dsChar">]</span> = <span class="dsChar">[]</span>
      list<span class="dsFloat">.</span>each_element(<span class="dsString">&quot;item&quot;</span>)<span class="dsKeyword"> do </span>|item|
        <span class="dsOthers">@keywords</span><span class="dsChar">[</span>type<span class="dsChar">]</span> &lt;&lt; Keyword<span class="dsFloat">.</span>new(item<span class="dsFloat">.</span>text<span class="dsFloat">.</span>strip, type)
<span class="dsKeyword">      end</span>
<span class="dsComment">#      warn &quot;keywords -&gt; #{@keywords['keywords'].inspect}&quot; if $DEBUG</span>
<span class="dsKeyword">    end</span>
    
   <span class="dsComment"> # read contexts</span>
    <span class="dsOthers">@contexts</span> = <span class="dsChar">{}</span>
    <span class="dsOthers">@rules</span><span class="dsFloat">.</span>elements<span class="dsChar">[</span><span class="dsString">&quot;contexts&quot;</span><span class="dsChar">]</span><span class="dsFloat">.</span>each_element(<span class="dsString">&quot;context&quot;</span>)<span class="dsKeyword"> do </span>|context|
      name = context<span class="dsFloat">.</span>attribute(<span class="dsString">&quot;name&quot;</span>)<span class="dsFloat">.</span>value
      c = Context<span class="dsFloat">.</span>new(context)
      <span class="dsOthers">@contexts</span><span class="dsChar">[</span>name<span class="dsChar">]</span> = c
      
      context<span class="dsFloat">.</span>each_element<span class="dsKeyword"> do </span>|rule|
        c<span class="dsFloat">.</span>add_rule(Rule<span class="dsFloat">.</span>new(rule, <span class="dsOthers">@keywords</span>))
<span class="dsKeyword">      end</span>
<span class="dsKeyword">    end</span>
    
   <span class="dsComment"> # read itemdata</span>
    <span class="dsOthers">@itemdata</span> = <span class="dsChar">{}</span>
    <span class="dsOthers">@rules</span><span class="dsFloat">.</span>elements<span class="dsChar">[</span><span class="dsString">&quot;itemDatas&quot;</span><span class="dsChar">]</span><span class="dsFloat">.</span>each_element(<span class="dsString">&quot;itemData&quot;</span>)<span class="dsKeyword"> do </span>|item|
      <span class="dsOthers">@itemdata</span><span class="dsChar">[</span>item<span class="dsFloat">.</span>attribute(<span class="dsString">&quot;name&quot;</span>)<span class="dsFloat">.</span>value<span class="dsChar">]</span> = item<span class="dsFloat">.</span>attribute(<span class="dsString">&quot;defStyleNum&quot;</span>)<span class="dsFloat">.</span>value
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
<span class="dsKeyword">end</span>

<span class="dsKeyword">module</span> Rule
<span class="dsKeyword">  def </span><span class="dsDecVal">self</span><span class="dsFloat">.</span>new(rule, *args)
    module_eval(<span class="dsString">&quot;Rule_&quot;</span>+rule<span class="dsFloat">.</span>name)<span class="dsFloat">.</span>new(rule, *args)
<span class="dsKeyword">  end</span>

<span class="dsKeyword">  class </span>Rule
    <span class="dsOthers">attr_reader</span><span class="dsString"> :attribute</span>,<span class="dsString"> :context</span>,<span class="dsString"> :size</span>,<span class="dsString"> :match</span>
<span class="dsKeyword">    def </span>initialize(rule)
      <span class="dsOthers">@attribute</span> = rule<span class="dsFloat">.</span>attribute(<span class="dsString">&quot;attribute&quot;</span>)<span class="dsFloat">.</span>value
      <span class="dsOthers">@context</span> = rule<span class="dsFloat">.</span>attribute(<span class="dsString">&quot;context&quot;</span>)<span class="dsFloat">.</span>value
      warn <span class="dsString">&quot;creating rule </span><span class="dsOthers">#{@attribute}</span><span class="dsString">, </span><span class="dsOthers">#{@context}</span><span class="dsString">&quot;</span><span class="dsKeyword"> if </span>$DEBUG
<span class="dsKeyword">    end</span>
    
<span class="dsKeyword">    def </span>scan(scanner, re)
      <span class="dsOthers">@match</span> = scanner<span class="dsFloat">.</span>scan(re)
      <span class="dsOthers">@size</span> = scanner<span class="dsFloat">.</span>matched_size
      <span class="dsOthers">@match</span>
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  module </span>RegExprScanner
<span class="dsKeyword">    def </span>setup(re)
      <span class="dsOthers">@re</span> = re
<span class="dsKeyword">    end</span>
    
<span class="dsKeyword">    def </span>apply(scanner)
      scan(scanner, <span class="dsOthers">@re</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_keyword &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, keywords)
      <span class="dsDecVal">super</span> rule
      list = rule<span class="dsFloat">.</span>attribute(<span class="dsString">&quot;String&quot;</span>)<span class="dsFloat">.</span>value
      setup(<span class="dsOthers">/(</span><span class="dsOthers">#{keywords[list].map { |k| Regexp.escape(k.name) + '\b' }</span><span class="dsOthers">.join(&quot;|&quot;)})/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_RegExpr &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      setup(<span class="dsOthers">/</span><span class="dsOthers">#{rule.attribute(&quot;String&quot;)}</span><span class="dsOthers">/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_DetectChar &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      setup(<span class="dsOthers">/</span><span class="dsOthers">#{Regexp.escape(rule.attribute(&quot;char&quot;).value)}</span><span class="dsOthers">/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_AnyChar &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      chars = Regexp<span class="dsFloat">.</span>escape(rule<span class="dsFloat">.</span>attribute(<span class="dsString">&quot;String&quot;</span>)<span class="dsFloat">.</span>value)
      setup(<span class="dsOthers">/[</span><span class="dsOthers">#{chars}</span><span class="dsOthers">]/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_StringDetect &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      setup(<span class="dsOthers">/</span><span class="dsOthers">#{Regexp.escape(rule.attribute(&quot;String&quot;).value)}</span><span class="dsOthers">/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
    
<span class="dsKeyword">  class </span>Rule_Detect2Chars &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      setup(<span class="dsOthers">/</span><span class="dsOthers">#{Regexp.escape(rule.attribute(&quot;char&quot;).value)}#{Regexp.escape(rule.attribute(&quot;char1&quot;).value)}</span><span class="dsOthers">/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_HlCChar &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      setup(<span class="dsOthers">/'.'/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_HlCStringChar &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      setup(<span class="dsOthers">/\\[abefnrtv&quot;'?\\]/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_RangeDetect &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      chars = %w(char char1)<span class="dsFloat">.</span>each<span class="dsKeyword"> do </span>|attribute|
        Regexp<span class="dsFloat">.</span>escape(rule<span class="dsFloat">.</span>attribute(attribute)<span class="dsFloat">.</span>value)
<span class="dsKeyword">      end</span>
      setup(<span class="dsOthers">/</span><span class="dsOthers">#{chars[0]}</span><span class="dsOthers">.*</span><span class="dsOthers">#{chars[1]}</span><span class="dsOthers">/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_LineContinue &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      setup(<span class="dsOthers">/\\$/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>

<span class="dsKeyword">  class </span>Rule_Float &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      setup(<span class="dsOthers">/[0-9]*\.[0-9]+([eE][-+]?[0-9]+)?/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_HlCOct &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      setup(<span class="dsOthers">/0[0-7]+(L|U)?/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_HlCHex &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      setup(<span class="dsOthers">/0x[0-9a-fA-F]+(L|U)?/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  class </span>Rule_Int &lt; Rule
    <span class="dsKeyword">include</span> RegExprScanner
<span class="dsKeyword">    def </span>initialize(rule, _)
      <span class="dsDecVal">super</span> rule
      setup(<span class="dsOthers">/[0-9]+/</span>)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">end</span>

<span class="dsKeyword">class</span> HLMatchList
<span class="dsKeyword">  class </span>HLMatch
    <span class="dsOthers">attr_reader</span><span class="dsString"> :first</span>,<span class="dsString"> :length</span>,<span class="dsString"> :attribute</span>
<span class="dsKeyword">    def </span>initialize(first, length, attribute)
      <span class="dsOthers">@first</span> = first
      <span class="dsOthers">@length</span> = length
      <span class="dsOthers">@attribute</span> = attribute
<span class="dsKeyword">    end</span>
    
<span class="dsKeyword">    def </span>last
      <span class="dsOthers">@first</span>+<span class="dsOthers">@length</span>
<span class="dsKeyword">    end</span>
    
<span class="dsKeyword">    def </span>redim(additional_length)
      <span class="dsOthers">@length</span> += additional_length
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  def </span>initialize
    <span class="dsOthers">@matches</span> = <span class="dsChar">[]</span>
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  def </span>add_match(start, length, attribute)
    last = <span class="dsOthers">@matches</span><span class="dsFloat">.</span>last
<span class="dsKeyword">    if </span>last <span class="dsKeyword">and</span> last<span class="dsFloat">.</span>last == start <span class="dsKeyword">and</span> last<span class="dsFloat">.</span>attribute == attribute
     <span class="dsComment"> # these matches can be combined</span>
      last<span class="dsFloat">.</span>redim(length)
<span class="dsKeyword">    else</span>
      <span class="dsOthers">@matches</span> &lt;&lt; HLMatch<span class="dsFloat">.</span>new(start, length, attribute)
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  
  <span class="dsKeyword">alias</span> &lt;&lt; add_match
  
<span class="dsKeyword">  def </span>each(&amp;blk)
    <span class="dsOthers">@matches</span><span class="dsFloat">.</span>each(&amp;blk)
<span class="dsKeyword">  end</span>
<span class="dsKeyword">end</span>

<span class="dsKeyword">class</span> Highlighter
<span class="dsKeyword">  def </span>initialize(rules)
    <span class="dsOthers">@rules</span> = rules
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  def </span>highlight(str)
    <span class="dsOthers">@contexts</span> = <span class="dsChar">[</span><span class="dsString">&quot;Normal&quot;</span><span class="dsChar">]</span>
    matches = <span class="dsChar">[]</span>
    str<span class="dsFloat">.</span>each_line<span class="dsKeyword"> do </span>|line|
      matches &lt;&lt; match(line<span class="dsFloat">.</span>chomp)
      update_context(<span class="dsOthers">@rules</span><span class="dsFloat">.</span>contexts<span class="dsChar">[</span>current_context<span class="dsChar">]</span><span class="dsFloat">.</span>line_end_context)
<span class="dsKeyword">    end</span>
    
    matches
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  def </span>current_context
    <span class="dsOthers">@contexts</span><span class="dsFloat">.</span>last
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  def </span>match(line)
    scanner = StringScanner<span class="dsFloat">.</span>new(line)
    matches = HLMatchList<span class="dsFloat">.</span>new
<span class="dsKeyword">    until </span>scanner<span class="dsFloat">.</span>eos?
      pointer = scanner<span class="dsFloat">.</span>pointer
      matched = <span class="dsDecVal">false</span>
      <span class="dsOthers">@rules</span><span class="dsFloat">.</span>contexts<span class="dsChar">[</span>current_context<span class="dsChar">]</span><span class="dsFloat">.</span>each<span class="dsKeyword"> do </span>|rule|
<span class="dsKeyword">        if </span>match = rule<span class="dsFloat">.</span>apply(scanner)
          warn <span class="dsString">&quot;rule matched </span><span class="dsOthers">#{match}</span><span class="dsString">: </span><span class="dsOthers">#{rule.attribute}</span><span class="dsString"> </span><span class="dsOthers">#{rule.class.name}</span><span class="dsString">&quot;</span><span class="dsKeyword"> if </span>$DEBUG
          update_context(rule<span class="dsFloat">.</span>context)
          matches<span class="dsFloat">.</span>add_match(pointer, rule<span class="dsFloat">.</span>size, rule<span class="dsFloat">.</span>attribute)
          matched = <span class="dsDecVal">true</span>
          <span class="dsKeyword">break</span>
<span class="dsKeyword">        end</span>
<span class="dsKeyword">      end</span>
      
<span class="dsKeyword">      unless </span>matched
       <span class="dsComment"> # if no rule matches</span>
        c = scanner<span class="dsFloat">.</span>scan(<span class="dsOthers">/./</span>)
        warn <span class="dsString">&quot;consuming '</span><span class="dsOthers">#{c}</span><span class="dsString">'&quot;</span><span class="dsKeyword"> if </span>$DEBUG
        matches<span class="dsFloat">.</span>add_match(pointer, 1, <span class="dsOthers">@rules</span><span class="dsFloat">.</span>contexts<span class="dsChar">[</span>current_context<span class="dsChar">]</span><span class="dsFloat">.</span>attribute)
<span class="dsKeyword">      end</span>
<span class="dsKeyword">    end</span>
    
    matches
<span class="dsKeyword">  end</span>
  
<span class="dsKeyword">  def </span>update_context(context)
<span class="dsKeyword">    if </span>context<span class="dsChar">[</span>0,1<span class="dsChar">]</span> == <span class="dsString">&quot;#&quot;</span>
<span class="dsKeyword">      case </span>context<span class="dsChar">[</span><span class="dsFloat">1..</span>-1<span class="dsChar">]</span>
      <span class="dsKeyword">when</span> <span class="dsString">&quot;stay&quot;</span>
        warn <span class="dsString">&quot;keeping current context </span><span class="dsOthers">#{current_context}</span><span class="dsString">&quot;</span><span class="dsKeyword"> if </span>$DEBUG
      <span class="dsKeyword">when</span> <span class="dsString">&quot;pop&quot;</span>
        <span class="dsOthers">@contexts</span><span class="dsFloat">.</span>pop
        warn <span class="dsString">&quot;switching back to context </span><span class="dsOthers">#{current_context}</span><span class="dsString">&quot;</span><span class="dsKeyword"> if </span>$DEBUG
<span class="dsKeyword">      end</span>
<span class="dsKeyword">    else</span>
      <span class="dsOthers">@contexts</span><span class="dsFloat">.</span>push(context)
      warn <span class="dsString">&quot;switching to context </span><span class="dsOthers">#{context}</span><span class="dsString">&quot;</span><span class="dsKeyword"> if </span>$DEBUG
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
<span class="dsKeyword">end</span>

<span class="dsKeyword">def</span> usage
  warn <span class="dsString">&quot;Usage: #$0 file&quot;</span>
  exit
<span class="dsKeyword">end</span>

rules = HighlightRules<span class="dsFloat">.</span>new(File<span class="dsFloat">.</span>new(<span class="dsString">'ruby.xml'</span>))
hl = Highlighter<span class="dsFloat">.</span>new(rules)
test_file = ARGV<span class="dsFloat">.</span>shift <span class="dsKeyword">or</span> usage
code = File<span class="dsFloat">.</span>new(test_file)<span class="dsFloat">.</span>read

puts &lt;&lt;EOF
&lt;html&gt;
&lt;head&gt;
&lt;link rel=<span class="dsString">&quot;stylesheet&quot;</span> type=<span class="dsString">&quot;text/css&quot;</span> href=<span class="dsString">&quot;code.css&quot;</span><span class="dsOthers">/&gt;</span>
&lt;<span class="dsOthers">/head&gt;</span>
&lt;body&gt;&lt;pre&gt;
EOF

data = hl<span class="dsFloat">.</span>highlight(code)
lines = code<span class="dsFloat">.</span>split(<span class="dsString">&quot;\n&quot;</span>)
data<span class="dsFloat">.</span>zip(lines)<span class="dsFloat">.</span>each<span class="dsKeyword"> do </span>|match_list, line|
  res = <span class="dsString">&quot;&quot;</span>
  match_list<span class="dsFloat">.</span>each<span class="dsKeyword"> do </span>|match|
    matched_line = line<span class="dsChar">[</span>match<span class="dsFloat">.</span>first<span class="dsFloat">...</span>match<span class="dsFloat">.</span>last<span class="dsChar">]</span>
    warn <span class="dsString">&quot;match = </span><span class="dsOthers">#{matched_line}</span><span class="dsString">&quot;</span><span class="dsKeyword"> if </span>$DEBUG
    matched_line = CGI<span class="dsFloat">.</span>escapeHTML(matched_line)
    warn <span class="dsString">&quot;match = </span><span class="dsOthers">#{matched_line}</span><span class="dsString">&quot;</span><span class="dsKeyword"> if </span>$DEBUG
    style = rules<span class="dsFloat">.</span>itemdata<span class="dsChar">[</span>match<span class="dsFloat">.</span>attribute<span class="dsChar">]</span>
<span class="dsKeyword">    if </span>style == <span class="dsString">&quot;dsNormal&quot;</span>
      res &lt;&lt; matched_line
<span class="dsKeyword">    else</span>
      res &lt;&lt; <span class="dsString">%Q{&lt;span class=&quot;</span><span class="dsOthers">#{style}</span><span class="dsString">&quot;&gt;</span><span class="dsOthers">#{matched_line}</span><span class="dsString">&lt;/span&gt;}</span>
<span class="dsKeyword">    end</span>
<span class="dsKeyword">  end</span>
  puts res
<span class="dsKeyword">end</span>

puts &lt;&lt;EOF
&lt;<span class="dsOthers">/pre&gt;&lt;/</span>body&gt;&lt;<span class="dsOthers">/html&gt;</span>
EOF
</pre></body></html>
